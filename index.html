<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Pagamentos e Projetos</title>
    <style>
        /* Estilos mantidos iguais */
    </style>
</head>
<body>
    <!-- HTML mantido igual -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            /* Configuração mantida igual */
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tasksRef = ref(db, 'tasks');
        let editingTaskKey = null;
        let editingSubtask = null;
        let addingSubtaskToKey = null;
        let currentCategory = 'payments';
        let expandedTasks = {};

        function saveTask(taskKey = null) {
            const taskInput = document.getElementById('taskInput');
            const dueDateInput = document.getElementById('dueDate');
            const priorityInput = document.getElementById('priority');
            const taskText = taskInput.value.trim();
            let dueDate = dueDateInput.value || null;
            const priority = parseInt(priorityInput.value) || 1;

            if (taskText === '') {
                document.getElementById('error').textContent = "Preencha a tarefa!";
                return;
            }

            const scrollBackAndExpand = (key) => {
                setTimeout(() => {
                    document.getElementById('success').textContent = '';
                    const element = document.querySelector(`li[data-key="${key}"]`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        const subtasksContainer = element.querySelector('.subtasks-container');
                        const expandBtn = element.querySelector('.expand-btn');
                        if (subtasksContainer && expandBtn) {
                            subtasksContainer.classList.add('visible');
                            expandBtn.textContent = '−';
                            expandedTasks[key] = true;
                        }
                    }
                }, 2000);
            };

            const validateSubtaskConstraints = (parentTask, newDueDate, newPriority) => {
                if (newDueDate && parentTask.dueDate && newDueDate > parentTask.dueDate) {
                    document.getElementById('error').textContent = "Data da subtarefa não pode ser posterior à da tarefa!";
                    return false;
                }
                if (newPriority > parentTask.priority) {
                    document.getElementById('error').textContent = "Prioridade da subtarefa não pode ser maior que a da tarefa!";
                    return false;
                }
                return true;
            };

            if (editingSubtask) {
                const { parentKey, index } = editingSubtask;
                const taskRef = ref(db, `tasks/${parentKey}`);
                onValue(taskRef, (snapshot) => {
                    const task = snapshot.val();
                    if (!validateSubtaskConstraints(task, dueDate, priority)) return;

                    const subtasks = task.subtasks || [];
                    subtasks[index] = {
                        text: taskText,
                        dueDate: dueDate,
                        priority: Math.min(Math.max(priority, 1), 1000),
                        notes: subtasks[index].notes || "",
                        completed: subtasks[index].completed || false
                    };
                    update(taskRef, { subtasks }).then(() => {
                        resetForm();
                        document.getElementById('success').textContent = "Subtarefa atualizada com sucesso!";
                        scrollBackAndExpand(parentKey);
                    }).catch((error) => {
                        document.getElementById('error').textContent = "Erro ao atualizar subtarefa: " + error.message;
                    });
                }, { onlyOnce: true });
            } else if (addingSubtaskToKey) {
                const taskRef = ref(db, `tasks/${addingSubtaskToKey}`);
                onValue(taskRef, (snapshot) => {
                    const task = snapshot.val();
                    if (!validateSubtaskConstraints(task, dueDate, priority)) return;

                    const subtasks = task.subtasks || [];
                    subtasks.push({
                        text: taskText,
                        dueDate: dueDate,
                        priority: Math.min(Math.max(priority, 1), 1000),
                        notes: "",
                        completed: false
                    });
                    update(taskRef, { subtasks }).then(() => {
                        expandedTasks[addingSubtaskToKey] = true;
                        resetForm();
                        document.getElementById('success').textContent = "Subtarefa adicionada com sucesso!";
                        scrollBackAndExpand(addingSubtaskToKey);
                    }).catch((error) => {
                        document.getElementById('error').textContent = "Erro ao adicionar subtarefa: " + error.message;
                    });
                }, { onlyOnce: true });
            } else if (editingTaskKey) {
                const taskRef = ref(db, `tasks/${editingTaskKey}`);
                onValue(taskRef, (snapshot) => {
                    const currentTask = snapshot.val();
                    set(taskRef, {
                        text: taskText,
                        dueDate: dueDate,
                        priority: Math.min(Math.max(priority, 1), 1000),
                        notes: currentTask.notes || "",
                        completed: currentTask.completed || false,
                        category: currentCategory,
                        subtasks: currentTask.subtasks || []
                    }).then(() => {
                        resetForm();
                        document.getElementById('success').textContent = "Tarefa atualizada com sucesso!";
                        scrollBackAndExpand(editingTaskKey);
                    }).catch((error) => {
                        document.getElementById('error').textContent = "Erro ao atualizar: " + error.message;
                    });
                }, { onlyOnce: true });
            } else {
                push(tasksRef, {
                    text: taskText,
                    dueDate: dueDate,
                    priority: Math.min(Math.max(priority, 1), 1000),
                    notes: "",
                    completed: false,
                    category: currentCategory,
                    subtasks: []
                }).then((newTaskRef) => {
                    resetForm();
                    document.getElementById('success').textContent = "Tarefa adicionada com sucesso!";
                    setTimeout(() => {
                        document.getElementById('success').textContent = '';
                        const newTaskElement = document.querySelector(`li[data-key="${newTaskRef.key}"]`);
                        if (newTaskElement) {
                            newTaskElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 2000);
                }).catch((error) => {
                    document.getElementById('error').textContent = "Erro ao adicionar: " + error.message;
                });
            }
        }

        function resetForm() {
            /* Função mantida igual */
        }

        function editTask(key) {
            /* Função mantida igual */
        }

        function addSubtask(parentKey) {
            /* Função mantida igual */
        }

        function editSubtask(parentKey, subtaskIndex) {
            /* Função mantida igual */
        }

        function toggleTask(key) {
            /* Função mantida igual */
        }

        function toggleSubtask(parentKey, subtaskIndex) {
            /* Função mantida igual */
        }

        function deleteTask(key) {
            /* Função mantida igual */
        }

        function deleteSubtask(parentKey, subtaskIndex) {
            /* Função mantida igual */
        }

        function toggleNotes(li) {
            /* Função mantida igual */
        }

        function updateNotes(key, textarea) {
            /* Função mantida igual */
        }

        function updateSubtaskNotes(parentKey, subtaskIndex, textarea) {
            /* Função mantida igual */
        }

        function toggleCategoryDropdown(dropdown) {
            /* Função mantida igual */
        }

        function toggleSubtasks(key, li) {
            /* Função mantida igual */
        }

        function changeCategory(key, newCategory) {
            /* Função mantida igual */
        }

        function formatDate(dateStr) {
            /* Função mantida igual */
        }

        function isPastDue(dueDate, completed) {
            /* Função mantida igual */
        }

        function isToday(dueDate) {
            /* Função mantida igual */
        }

        function isOneDayPast(dueDate) {
            /* Função mantida igual */
        }

        function isTwoOrMoreDaysPast(dueDate) {
            /* Função mantida igual */
        }

        function setCategory(category) {
            /* Função mantida igual */
        }

        function renderTasks() {
            /* Função mantida igual */
        }

        setCategory('payments');

        document.getElementById('paymentsBtn').addEventListener('click', () => setCategory('payments'));
        document.getElementById('proposedBtn').addEventListener('click', () => setCategory('proposed'));
        document.getElementById('inProgressBtn').addEventListener('click', () => setCategory('inProgress'));
        document.getElementById('futureBtn').addEventListener('click', () => setCategory('future'));
        document.getElementById('allBtn').addEventListener('click', () => setCategory('all'));

        document.getElementById('actionButton').addEventListener('click', () => {
            const key = editingSubtask ? editingSubtask.parentKey : (addingSubtaskToKey || editingTaskKey);
            saveTask(key);
        });

        document.getElementById('taskInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const key = editingSubtask ? editingSubtask.parentKey : (addingSubtaskToKey || editingTaskKey);
                saveTask(key);
            }
        });
        document.getElementById('dueDate').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const key = editingSubtask ? editingSubtask.parentKey : (addingSubtaskToKey || editingTaskKey);
                saveTask(key);
            }
        });
        document.getElementById('priority').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const key = editingSubtask ? editingSubtask.parentKey : (addingSubtaskToKey || editingTaskKey);
                saveTask(key);
            }
        });
    </script>
</body>
</html>
